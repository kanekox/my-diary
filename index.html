<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Diary</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>

<body>
  <div class="container">
    <h1>ğŸ““ My Diary</h1>
    <form id="diaryForm" onsubmit="return false;">
      <label id="diaryLabel" for="diaryText">æ—¥è¨˜ã‚’å…¥åŠ›</label>
      <textarea id="diaryText" rows="4" cols="40" placeholder="ä»Šæ—¥ã®å‡ºæ¥äº‹..."></textarea>
      <div class="color-select" style="margin:8px 0;">
        <span>èƒŒæ™¯è‰²ï¼š</span>
        <label style="background:#f8f9fa; padding:2px 8px; border-radius:4px; margin-right:8px;">
          <input type="radio" name="bgColor" value="#f8f9fa" checked> 1
        </label>
        <label style="background:#e3f2fd; padding:2px 8px; border-radius:4px; margin-right:8px;">
          <input type="radio" name="bgColor" value="#e3f2fd"> 2
        </label>
        <label style="background:#fff3e0; padding:2px 8px; border-radius:4px;">
          <input type="radio" name="bgColor" value="#fff3e0"> 3
        </label>
      </div>
      <div class="form-actions">
        <button id="saveBtn" type="button">ä¿å­˜</button>
        <button id="cancelBtn" type="button"
          style="display:none; margin-left:8px; background:#eee; color:#333;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>

        <div style="flex-grow: 1;"></div>
        <input type="text" id="searchInput" placeholder="æ¤œç´¢èªå¥...">
        <button id="searchBtn" type="button"><span class="material-symbols-outlined"
            style="font-size: 18px; vertical-align: middle;">search</span></button>
      </div>
      <p id="status" style="margin: 5px 0; min-height: 1.2em; font-size: 0.9em; color: #666;"></p>
    </form>

    <ul id="diaryList"></ul>

    <div id="pagination">
      <button id="prevBtn" class="page-btn">å‰ã¸</button>
      <span id="pageInfo">1ãƒšãƒ¼ã‚¸ç›®</span>
      <button id="nextBtn" class="page-btn">æ¬¡ã¸</button>
    </div>
  </div>

  <script type="module">
    // ç·¨é›†çŠ¶æ…‹ç®¡ç†ç”¨
    let editingId = null;

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ»æ¤œç´¢ç®¡ç†ç”¨
    let currentPage = 1;
    const PAGE_SIZE = 20;
    // ãƒšãƒ¼ã‚¸ã”ã¨ã®æœ€å¾Œã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆã‚«ãƒ¼ã‚½ãƒ«ï¼‰ã‚’ä¿å­˜
    // pageCursors[0] ã¯æœªä½¿ç”¨, pageCursors[1] ã¯1ãƒšãƒ¼ã‚¸ç›®ã®æœ€å¾Œã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
    let pageCursors = [];
    let isSearchMode = false;

    // ç·¨é›†é–‹å§‹
    window.startEditDiary = function (id, data) {
      editingId = id;
      document.getElementById("diaryText").value = data.text;
      // è‰²ã‚’ã‚»ãƒƒãƒˆ
      if (data.color) {
        const radios = document.querySelectorAll('input[name="bgColor"]');
        radios.forEach(r => { r.checked = (r.value === data.color); });
      }
      // ãƒœã‚¿ãƒ³ãƒ»UIåˆ‡æ›¿
      document.getElementById("saveBtn").textContent = "æ›´æ–°";
      document.getElementById("cancelBtn").style.display = "inline-block";
      document.getElementById("diaryLabel").textContent = "æ—¥è¨˜ã‚’å…¥åŠ›ï¼šç·¨é›†ä¸­";
      document.getElementById("status").textContent = "";
    };

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    document.getElementById("cancelBtn").onclick = function () {
      resetForm();
    };

    function resetForm() {
      editingId = null;
      document.getElementById("diaryText").value = "";
      document.querySelector('input[name="bgColor"]').checked = true;
      document.getElementById("saveBtn").textContent = "ä¿å­˜";
      document.getElementById("cancelBtn").style.display = "none";
      document.getElementById("diaryLabel").textContent = "æ—¥è¨˜ã‚’å…¥åŠ›";
      document.getElementById("status").textContent = "";
    }

    // Firebase SDK èª­ã¿è¾¼ã¿
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy, limit, startAfter }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGvRDZdogbWVR-Vn03lkPzLqMszX0f9eo",
      authDomain: "kanekox-apps.firebaseapp.com",
      projectId: "kanekox-apps",
      storageBucket: "kanekox-apps.firebasestorage.app",
      messagingSenderId: "968979817079",
      appId: "1:968979817079:web:4e1ca76e2f4ef765ba1c72",
      measurementId: "G-C76YD903J2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // æ—¥è¨˜å‰Šé™¤
    window.deleteDiary = async function (id) {
      if (!confirm("å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

      try {
        await deleteDoc(doc(db, "diary", id));
        if (editingId === id) {
          document.getElementById("cancelBtn").click();
        }
        // å‰Šé™¤å¾Œã¯ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆç°¡æ˜“å¯¾å¿œï¼‰
        // é …ç›®ãŒæ¸›ã‚‹ã¨æ¬¡ãƒšãƒ¼ã‚¸ã®ç¹°ã‚Šä¸Šã’ãªã©ãŒèµ·ãã‚‹ãŸã‚ã€å³å¯†ã«ã¯å†å–å¾—ãŒæœ›ã¾ã—ã„
        if (isSearchMode) {
          handleSearch(); // å†æ¤œç´¢
        } else {
          // ã‚«ãƒ¬ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã®ã‚«ãƒ¼ã‚½ãƒ«ãŒç„¡åŠ¹ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€
          // ãƒšãƒ¼ã‚¸1ã«æˆ»ã‚‹ã‹ã€ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã‚’å†ãƒ­ãƒ¼ãƒ‰ã€‚
          // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ãƒšãƒ¼ã‚¸1ã«æˆ»ã™ï¼ˆãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ãŸã‚ï¼‰
          currentPage = 1;
          pageCursors = [];
          await loadDiaryPage(1);
        }
      } catch (error) {
        console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    };

    async function saveDiary() {
      const saveBtn = document.getElementById("saveBtn");
      const status = document.getElementById("status");
      const text = document.getElementById("diaryText").value.trim();
      const color = document.querySelector('input[name="bgColor"]:checked').value;

      if (!text) {
        status.textContent = "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        return;
      }

      try {
        saveBtn.disabled = true;
        status.textContent = "ä¿å­˜ä¸­...";

        if (editingId) {
          // ç·¨é›†
          const ref = doc(db, "diary", editingId);
          await updateDoc(ref, {
            text: text,
            color: color
          });
        } else {
          // æ–°è¦
          await addDoc(collection(db, "diary"), {
            text: text,
            color: color,
            createdAt: serverTimestamp()
          });
        }

        resetForm();
        status.textContent = "ä¿å­˜ã—ã¾ã—ãŸ";

        // ä¿å­˜å¾Œã¯æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã—ã¦æœ€æ–°ã‚’è¡¨ç¤º
        isSearchMode = false;
        document.getElementById("searchInput").value = "";
        currentPage = 1;
        pageCursors = [];
        await loadDiaryPage(1);

      } catch (error) {
        status.textContent = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
      } finally {
        saveBtn.disabled = false;
      }
    }

    // æ—¥è¨˜ä¸€è¦§è¡¨ç¤ºï¼ˆå…±é€šå‡¦ç†ï¼‰
    function renderList(docsData) {
      const diaryList = document.getElementById("diaryList");
      diaryList.innerHTML = "";

      if (docsData.length === 0) {
        diaryList.innerHTML = '<li style="text-align:center; background:none; box-shadow:none;">è¡¨ç¤ºã™ã‚‹æ—¥è¨˜ãŒã‚ã‚Šã¾ã›ã‚“</li>';
        return;
      }

      docsData.forEach(item => {
        const { id, data } = item;
        const createdAt = data.createdAt ? data.createdAt.toDate() : null;
        const dateStr = createdAt
          ? `${createdAt.getFullYear()}/${createdAt.getMonth() + 1}/${createdAt.getDate()}ï¼ˆ${["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][createdAt.getDay()]}ï¼‰ ${createdAt.toLocaleTimeString("ja-JP", { hour12: false })}`
          : "æ—¥æ™‚ä¸æ˜";

        const li = document.createElement("li");
        li.dataset.id = id;

        // èƒŒæ™¯è‰²
        li.style.background = data.color || "#f8f9fa";

        // Inner HTML Construction
        const html = `
          <div class="date-edit-wrap">
            <div class="date">${dateStr}</div>
            <button type="button" class="edit-btn" onclick="startEditDiary('${id}', {text: '${data.text.replace(/'/g, "&apos;").replace(/\n/g, "\\n")}', color: '${data.color}'})"><span class="material-symbols-outlined" style="font-size:16px;">edit</span></button>
            <button type="button" class="delete-btn" onclick="deleteDiary('${id}')"><span class="material-symbols-outlined" style="font-size:16px;">delete</span></button>
          </div>
          <div class="text">${data.text}</div>
        `;
        li.innerHTML = html;

        // ç·¨é›†ãƒœã‚¿ãƒ³ã®onclickã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™ã®ã¯ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãŒé¢å€’ãªã®ã§ã€
        // onclickã‚¤ãƒ™ãƒ³ãƒˆã‚’JSã§è¨­å®šã—ç›´ã™ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚‚ã‚ã‚‹ãŒã€ã“ã“ã§ã¯ä¿®æ­£ã—ã¦ãƒ‡ãƒ¼ã‚¿å±æ€§ãªã©ã¯ä½¿ã‚ãšã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã§æ¸¡ã™ã«ã¯forEachå†…ã§æ§‹ç¯‰ã™ã‚‹ã®ãŒæ¥½ã€‚
        // ä¸Šè¨˜ã®innerHTMLã‚¢ãƒ—ãƒ­ãƒ¼ãƒã ã¨onclickå†…ã®ãƒ‡ãƒ¼ã‚¿æ¸¡ã—ãŒå£Šã‚Œã‚„ã™ã„ã®ã§ã€createElementã§å†æ§‹æˆã—ã¾ã™ã€‚

        li.innerHTML = ""; // Clear

        const dateWrap = document.createElement("div");
        dateWrap.className = "date-edit-wrap";

        const dateEl = document.createElement("div");
        dateEl.className = "date";
        dateEl.textContent = dateStr;

        const editBtn = document.createElement("button");
        editBtn.className = "edit-btn";
        editBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px;">edit</span>';
        editBtn.onclick = () => startEditDiary(id, data);

        const delBtn = document.createElement("button");
        delBtn.className = "delete-btn";
        delBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px;">delete</span>';
        delBtn.onclick = () => deleteDiary(id);

        dateWrap.appendChild(dateEl);
        dateWrap.appendChild(editBtn);
        dateWrap.appendChild(delBtn);

        const textEl = document.createElement("div");
        textEl.className = "text";
        textEl.textContent = data.text;

        li.appendChild(dateWrap);
        li.appendChild(textEl);

        diaryList.appendChild(li);
      });
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–¢æ•°
    async function loadDiaryPage(page) {
      if (isSearchMode) return; // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã‚’ã—ãªã„ï¼ˆã‚ã‚‹ã„ã¯æ¤œç´¢çµæœç”¨ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã«ã™ã‚‹ï¼‰

      const diaryList = document.getElementById("diaryList");
      diaryList.style.opacity = "0.5"; // ãƒ­ãƒ¼ãƒ‰ä¸­æ„Ÿ

      try {
        let q;
        if (page === 1) {
          q = query(collection(db, "diary"), orderBy("createdAt", "desc"), limit(PAGE_SIZE));
        } else {
          // å‰ã®ãƒšãƒ¼ã‚¸ã®æœ€å¾Œã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
          const prevCursor = pageCursors[page - 1];
          if (!prevCursor) {
            // ã‚«ãƒ¼ã‚½ãƒ«ãŒãªã„å ´åˆã¯ãƒšãƒ¼ã‚¸1ã«æˆ»ã™
            currentPage = 1;
            return loadDiaryPage(1);
          }
          q = query(collection(db, "diary"), orderBy("createdAt", "desc"), startAfter(prevCursor), limit(PAGE_SIZE));
        }

        const querySnapshot = await getDocs(q);

        const items = [];
        querySnapshot.forEach(doc => {
          items.push({ id: doc.id, data: doc.data() });
        });

        renderList(items);

        // ã‚«ãƒ¼ã‚½ãƒ«ä¿å­˜ï¼ˆç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®æœ€å¾Œã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰
        if (querySnapshot.docs.length > 0) {
          pageCursors[page] = querySnapshot.docs[querySnapshot.docs.length - 1];
        }

        // UIæ›´æ–°
        document.getElementById("pageInfo").textContent = `${page}ãƒšãƒ¼ã‚¸ç›®`;
        document.getElementById("prevBtn").disabled = (page === 1);
        // æ¬¡ã®ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã‹ã©ã†ã‹ã¯ã€å–å¾—æ•°ãŒPAGE_SIZEã¨åŒã˜ã‹ã©ã†ã‹ã§æ¨æ¸¬
        document.getElementById("nextBtn").disabled = (querySnapshot.docs.length < PAGE_SIZE);

        // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
        document.getElementById("pagination").style.display = "flex";

      } catch (e) {
        console.error("Load Error", e);
        document.getElementById("status").textContent = "èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
      } finally {
        diaryList.style.opacity = "1";
      }
    }

    // æ¤œç´¢æ©Ÿèƒ½
    async function handleSearch() {
      const term = document.getElementById("searchInput").value.trim();
      if (!term) {
        // ç©ºã®å ´åˆã¯æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰è§£é™¤ã—ã¦ãƒªã‚»ãƒƒãƒˆ
        isSearchMode = false;
        currentPage = 1;
        pageCursors = [];
        document.getElementById("status").textContent = "";
        loadDiaryPage(1);
        return;
      }

      isSearchMode = true;
      document.getElementById("pagination").style.display = "none"; // æ¤œç´¢çµæœã¯ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãªã—ï¼ˆå…¨ä»¶è¡¨ç¤ºï¼‰
      document.getElementById("status").textContent = "æ¤œç´¢ä¸­...";

      const diaryList = document.getElementById("diaryList");
      diaryList.style.opacity = "0.5";

      try {
        // æ¤œç´¢æ™‚ã¯å…¨ä»¶å–å¾—ã—ã¦JSã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆFirestoreã®åˆ¶ç´„ã®ãŸã‚ï¼‰
        // è¨˜äº‹æ•°ãŒæ•°åƒä»¶ã«ãªã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å½±éŸ¿ãŒå‡ºã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
        const q = query(collection(db, "diary"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);

        const results = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          if (d.text && d.text.includes(term)) {
            results.push({ id: doc.id, data: d });
          }
        });

        renderList(results);
        document.getElementById("status").textContent = `${results.length}ä»¶è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

      } catch (e) {
        console.error("Search Error", e);
        document.getElementById("status").textContent = "æ¤œç´¢ã‚¨ãƒ©ãƒ¼";
      } finally {
        diaryList.style.opacity = "1";
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    window.addEventListener('DOMContentLoaded', () => {
      const saveBtn = document.getElementById("saveBtn");
      if (saveBtn) saveBtn.addEventListener("click", saveDiary);

      const searchBtn = document.getElementById("searchBtn");
      if (searchBtn) searchBtn.addEventListener("click", handleSearch);

      // Enterã‚­ãƒ¼ã§æ¤œç´¢
      document.getElementById("searchInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault(); // Form submité˜²æ­¢
          handleSearch();
        }
      });

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
      document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          loadDiaryPage(currentPage);
        }
      });

      document.getElementById("nextBtn").addEventListener("click", () => {
        currentPage++;
        loadDiaryPage(currentPage);
      });

      // åˆæœŸãƒ­ãƒ¼ãƒ‰
      loadDiaryPage(1);
    });
  </script>
</body>

</html>