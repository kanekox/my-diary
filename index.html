<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Diary</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>

<body>
  <div class="container">
    <h1>ğŸ““ My Diary</h1>
    <form id="diaryForm" onsubmit="return false;">
      <label id="diaryLabel" for="diaryText">æ—¥è¨˜ã‚’å…¥åŠ›</label>
      <textarea id="diaryText" rows="4" cols="40" placeholder="ä»Šæ—¥ã®å‡ºæ¥äº‹..."></textarea>
      <div class="color-select" style="margin:8px 0;">
        <span>èƒŒæ™¯è‰²ï¼š</span>
        <label style="background:#f8f9fa; padding:2px 8px; border-radius:4px; margin-right:8px;">
          <input type="radio" name="bgColor" value="#f8f9fa" checked> 1
        </label>
        <label style="background:#e3f2fd; padding:2px 8px; border-radius:4px; margin-right:8px;">
          <input type="radio" name="bgColor" value="#e3f2fd"> 2
        </label>
        <label style="background:#fff3e0; padding:2px 8px; border-radius:4px;">
          <input type="radio" name="bgColor" value="#fff3e0"> 3
        </label>
      </div>
      <div class="form-actions">
        <button id="saveBtn" type="button">ä¿å­˜</button>
        <button id="cancelBtn" type="button"
          style="display:none; margin-left:8px; background:#eee; color:#333;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <span id="status" role="status" aria-live="polite"></span>
      </div>
    </form>
    <h2>æ—¥è¨˜ä¸€è¦§</h2>
    <ul id="diaryList"></ul>
  </div>

  <script type="module">
    // ç·¨é›†çŠ¶æ…‹ç®¡ç†ç”¨
    let editingId = null;

    // ç·¨é›†é–‹å§‹
    window.startEditDiary = function (id, data) {
      editingId = id;
      document.getElementById("diaryText").value = data.text;
      // è‰²ã‚’ã‚»ãƒƒãƒˆ
      if (data.color) {
        const radios = document.querySelectorAll('input[name="bgColor"]');
        radios.forEach(r => { r.checked = (r.value === data.color); });
      }
      // ãƒœã‚¿ãƒ³ãƒ»UIåˆ‡æ›¿
      document.getElementById("saveBtn").textContent = "æ›´æ–°";
      document.getElementById("cancelBtn").style.display = "inline-block";
      document.getElementById("diaryLabel").textContent = "æ—¥è¨˜ã‚’å…¥åŠ›ï¼šç·¨é›†ä¸­";
      document.getElementById("status").textContent = "";
    };

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    document.getElementById("cancelBtn").onclick = function () {
      editingId = null;
      document.getElementById("diaryText").value = "";
      document.querySelector('input[name="bgColor"]').checked = true;
      document.getElementById("saveBtn").textContent = "ä¿å­˜";
      document.getElementById("cancelBtn").style.display = "none";
      document.getElementById("diaryLabel").textContent = "æ—¥è¨˜ã‚’å…¥åŠ›";
      document.getElementById("status").textContent = "";
    };
    // Firebase SDK èª­ã¿è¾¼ã¿
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // firebaseConfigï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyBGvRDZdogbWVR-Vn03lkPzLqMszX0f9eo",
      authDomain: "kanekox-apps.firebaseapp.com",
      projectId: "kanekox-apps",
      storageBucket: "kanekox-apps.firebasestorage.app",
      messagingSenderId: "968979817079",
      appId: "1:968979817079:web:4e1ca76e2f4ef765ba1c72",
      measurementId: "G-C76YD903J2"
    };

    // åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // æ—¥è¨˜ä¿å­˜
    import { doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // æ—¥è¨˜å‰Šé™¤
    window.deleteDiary = async function (id) {
      if (!confirm("å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

      try {
        await deleteDoc(doc(db, "diary", id));
        // ã‚‚ã—ç·¨é›†ä¸­ã®æ—¥è¨˜ã‚’å‰Šé™¤ã—ãŸå ´åˆã¯ãƒªã‚»ãƒƒãƒˆ
        if (editingId === id) {
          document.getElementById("cancelBtn").click();
        }
        await loadDiary();
      } catch (error) {
        console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    };

    async function saveDiary() {
      const saveBtn = document.getElementById("saveBtn");
      const status = document.getElementById("status");
      const text = document.getElementById("diaryText").value.trim();
      const color = document.querySelector('input[name="bgColor"]:checked').value;

      if (!text) {
        status.textContent = "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        return;
      }

      try {
        saveBtn.disabled = true;
        status.textContent = "ä¿å­˜ä¸­...";

        if (editingId) {
          // ç·¨é›†: updateDoc
          const ref = doc(db, "diary", editingId);
          await updateDoc(ref, {
            text: text,
            color: color
          });
        } else {
          // æ–°è¦: addDoc
          await addDoc(collection(db, "diary"), {
            text: text,
            color: color,
            createdAt: serverTimestamp()
          });
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        editingId = null;
        document.getElementById("diaryText").value = "";
        document.querySelector('input[name="bgColor"]').checked = true;
        document.getElementById("saveBtn").textContent = "ä¿å­˜";
        document.getElementById("cancelBtn").style.display = "none";
        document.getElementById("diaryLabel").textContent = "æ—¥è¨˜ã‚’å…¥åŠ›";
        status.textContent = "";
        await loadDiary();
      } catch (error) {
        status.textContent = "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
        console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
      } finally {
        saveBtn.disabled = false;
      }
    }

    // æ—¥è¨˜ä¸€è¦§å–å¾—
    async function loadDiary() {
      const diaryList = document.getElementById("diaryList");
      diaryList.innerHTML = "";

      const q = query(collection(db, "diary"), orderBy("createdAt", "desc"));
      const querySnapshot = await getDocs(q);

      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const createdAt = data.createdAt ? data.createdAt.toDate() : null;
        const dateStr = createdAt
          ? createdAt.toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" })
          : "æ—¥æ™‚ä¸æ˜";

        const li = document.createElement("li");
        li.dataset.id = doc.id;
        const dateEl = document.createElement("div");
        const textEl = document.createElement("div");

        dateEl.textContent = dateStr;
        textEl.textContent = data.text;

        dateEl.classList.add("date");
        textEl.classList.add("text");

        // èƒŒæ™¯è‰²ã‚’åæ˜ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯#f8f9faï¼‰
        li.style.background = data.color || "#f8f9fa";
        li.style.margin = "12px 0";
        li.style.borderRadius = "8px";
        li.style.padding = "8px 12px";
        li.style.listStyle = "none";

        // ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆæ—¥æ™‚ã®ä¸‹ã«å°ã•ãè¡¨ç¤ºï¼‰
        const editBtn = document.createElement("button");
        editBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px;">edit</span>';
        editBtn.title = "ç·¨é›†";
        editBtn.type = "button";
        editBtn.className = "edit-btn";
        editBtn.onclick = () => startEditDiary(doc.id, data);

        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size:16px;">delete</span>';
        deleteBtn.title = "å‰Šé™¤";
        deleteBtn.type = "button";
        deleteBtn.className = "delete-btn";
        deleteBtn.onclick = () => deleteDiary(doc.id);

        // æ—¥æ™‚ã¨ç·¨é›†ãƒœã‚¿ãƒ³ã‚’å³è©°ã‚æ¨ªä¸¦ã³
        const dateWrap = document.createElement("div");
        dateWrap.className = "date-edit-wrap";
        dateWrap.appendChild(dateEl);
        dateWrap.appendChild(editBtn);
        dateWrap.appendChild(deleteBtn);
        li.appendChild(dateWrap);
        li.appendChild(textEl);
        diaryList.appendChild(li);
      });
    }

    // åˆæœŸåŒ–: ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ã¨ä¸€è¦§èª­ã¿è¾¼ã¿
    window.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById("saveBtn");
      if (btn) btn.addEventListener("click", saveDiary);
      loadDiary();
    });
  </script>
</body>

</html>